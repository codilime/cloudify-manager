tosca_definitions_version: cloudify_dsl_1_0

imports:
    - cloudify/types/types.yaml
    - plugins/diamond.yaml
    - mock_autoheal.yaml
    - mock_topology.yaml
    - plugins/mock_workflows.yaml
    - plugins/testmockoperations.yaml
    - policies/snmp_policy.yaml
    - snmp_types.yaml

node_templates:

    SNMPDevice:
        type: cloudify.nodes.Compute
        interfaces:
            test:
                op1: testmockoperations.testmockoperations.tasks.saving_multiple_params_op

    SNMPProxyNode:
        type: SNMPProxy
        relationships:
            - type: cloudify.relationships.depends_on
              target: SNMPDevice
              source_interfaces:
                  cloudify.interfaces.relationship_lifecycle:
                      preconfigure:
                          implementation: scripts/operations/append_diamond_conf.py
                          executor: central_deployment_agent
                          inputs:
                              port: 1161
                              community: public
                              host: localhost
                              oids:
                                  1.3.6.1.4.1.2021.10.1.3.1: cpu.load.1min
                                  1.3.6.1.4.1.2021.10.1.3.2: cpu.load.5min
                                  1.3.6.1.4.1.2021.10.1.3.3: cpu.load.15min

groups:
    autohealing_group:
        members: [SNMPDevice]
        policies:
            snmp_policy:
                type: snmp_policy
                triggers:
                    auto_heal_trigger:
                        type: cloudify.policies.triggers.execute_workflow
                        parameters:
                            workflow: snmp_workflow
                            force: true
                            workflow_parameters:
                                node_id: { get_property: [SELF, node_id] }
                                metric: { get_property: [SELF, metric] }
                                metric_name: { get_property: [SELF, path] }
workflows:
    snmp_workflow:
        mapping: mock_workflows.mock_workflows.workflows.snmp_workflow
        parameters:
            node_id:
                description: Which node is observed
            metric:
                description: metric value
            metric_name:
                description: OID
    delete_diamond_workflow:
        mapping: mock_workflows.mock_workflows.workflows.delete_diamond_workflow
        parameters:
            node_id:
                description: On which node to stop diamond
